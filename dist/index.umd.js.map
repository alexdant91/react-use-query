{"version":3,"file":"index.umd.js","sources":["../src/index.js"],"sourcesContent":["import { useState, useEffect, useRef, createContext, useContext } from 'react';\n\n/**\n * @callback QueryResultCacheFn\n * @param {string} url\n * \n * @typedef {object} QueryResultCache\n * @property {QueryResultCacheFn} get\n * @property {QueryResultCacheFn} has\n * @property {QueryResultCacheFn} clear\n *\n * @typedef {object} QueryResult\n * @property {*} data\n * @property {Error|false} error\n * @property {boolean} loading\n * @property {function} updateData\n * @property {function} refresh\n * @property {QueryResultCache} cache\n * \n * @typedef {object} DefaultUseQueryOptions\n * @property {string} [selector] \n * @property {function} [manipulate] \n * @property {string} [method=\"GET\"] \n * @property {object} [headers] \n * @property {*} [body] \n * @property {boolean} [isDebuggerActivated=false] \n * @property {number} [cacheTimeout=0] \n */\n\nconst DEFAULT_OPTIONS = {\n    selector: undefined,\n    manipulate: undefined,\n    method: \"GET\",\n    headers: undefined,\n    body: undefined,\n    isDebuggerActivated: false,\n    cacheTimeout: 0,\n};\n\nlet cacheTimeout = null;\n\n/**\n * @param {string} [message=\"\"] \n * @param {boolean} [isDebuggerActivated=false]\n * @param {boolean} [isError=false] \n * @param {null|string|Error} [error=null]\n */\nconst logDebugger = (message = \"\", isDebuggerActivated = false, isError = false, error = null) => {\n    if (isError) {\n        if (isDebuggerActivated) console.error(`[USE_QUERY]: ${message} - ${new Date().toLocaleTimeString()}`, error);\n    } else {\n        if (isDebuggerActivated) console.log(`[USE_QUERY]: ${message} - ${new Date().toLocaleTimeString()}`);\n    }\n}\n\n/**\n * @param {DefaultUseQueryOptions} options \n * @returns {boolean}\n */\nconst validateOptions = (options) => {\n    const keys = Object.keys(DEFAULT_OPTIONS);\n    const _keys = Object.keys(options);\n    const symDifference = _keys.filter(item => !keys.includes(item));\n\n    if (options.selector !== undefined && typeof options.selector !== \"string\") {\n        logDebugger(\"Validation error for `options.selector`\", isDebuggerActivated, true, new Error(\"Selector must be a string. It should contains key value to select from result object.\"));\n        return false;\n    } else if (options.method !== undefined && (typeof options.method !== \"string\" || [\"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\"].indexOf(options.method.toUpperCase()) === -1)) {\n        logDebugger(\"Validation error for `options.method`\", isDebuggerActivated, true, new Error('Method must be a string. It should be one of \"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\".'));\n        return false;\n    } else if (options.headers !== undefined && typeof options.headers !== \"object\" && Array.isArray(options.headers)) {\n        logDebugger(\"Validation error for `options.headers`\", isDebuggerActivated, true, new Error(\"Headers must be an object. It should contains request headers key value.\"));\n        return false;\n    } else if (options.isDebuggerActivated !== undefined && typeof options.isDebuggerActivated !== \"boolean\" && Array.isArray(options.headers)) {\n        logDebugger(\"Validation error for `options.isDebuggerActivated`\", true, true, new Error(\"isDebuggerActivated must be a boolean. It should be activated if you need to debug all process.\"));\n        return false;\n    } else if (options.manipulate !== undefined && typeof options.manipulate !== \"function\") {\n        logDebugger(\"Validation error for `options.manipulate`\", true, true, new Error(\"manipulate must be a function. It rappresent the funcion to manipulate data before saving on state.\"));\n        return false;\n    } else if (options.cacheTimeout !== undefined && typeof options.cacheTimeout !== \"number\") {\n        logDebugger(\"Validation error for `options.cacheTimeout`\", true, true, new Error(\"cacheTimeout must be a number. It rappresent the timeout to remove cached data from memory in milliseconds.\"));\n        return false;\n    }\n    \n    if (symDifference.length > 0) {\n        logDebugger(\"Validation error\", true, true, new Error(`Found not valid option${symDifference.length > 1 ? \"s\" : \"\"}: \"${symDifference.join('\", \"')}\".`));\n        return false;\n    }\n\n    return true;\n}\n\n/**\n * @param {DefaultUseQueryOptions} options \n * @param {MutableRefObject} cache \n */\nconst timeoutCacheClear = (options, cache) => {\n    if (options.cacheTimeout && options.cacheTimeout > 0) {\n        logDebugger(`Cache clear timeout start: ${options.cacheTimeout / 1000} seconds.`, options.isDebuggerActivated);\n        clearTimeout(cacheTimeout);\n        cacheTimeout = setTimeout(() => {\n            cache.current = {};\n            logDebugger(`Cache cleared`, options.isDebuggerActivated);\n        }, options.cacheTimeout);\n    }\n}\n\nconst QueryContext = createContext(null);\n\nexport const QueryProvider = ({ children }) => {\n    const [state, setState] = useState(null);\n    return (\n        <QueryContext.Provider value={[state, setState]}>\n            {children}\n        </QueryContext.Provider>\n    )\n}\n\nexport const useQueryContext = () => useContext(QueryContext);\n\n/**\n * Use query hook that manage requests, cache and other features.\n * @param {string} url \n * @param {object} options\n * @param {string} [options.selector] Selector must be a string. It should contains key value to select from result object.\n * @param {function} [options.manipulate] manipulate must be a function. It rappresent the funcion to manipulate data before saving on state. If you need to mutate data, use `mutate` function instead\n * @param {string} [options.method] Method must be a string. It should be one of \"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\".\n * @param {object} [options.headers] Headers must be an object. It should contains request headers key value.\n * @param {*} [options.body]\n * @param {boolean} [options.isDebuggerActivated] isDebuggerActivated must be a boolean. It should be activated if you need to debug all process.\n * @param {number} [options.cacheTimeout] cacheTimeout must be a number. It rappresent the timeout to remove cached data from memory in milliseconds.\n * @returns {QueryResult}\n */\nexport const useQuery = (url, options = { ...DEFAULT_OPTIONS }) => {\n    const { selector, manipulate, method, headers, body, isDebuggerActivated } = { ...DEFAULT_OPTIONS, ...options };\n\n    validateOptions({ ...DEFAULT_OPTIONS, ...options });\n    \n    const cache = useRef({});\n\n    const [data, setData] = useQueryContext();\n    const [error, setError] = useState(null);\n    const [loading, setLoading] = useState(false);\n\n    const fetchData = async () => {\n        logDebugger(\"Fetching data...\", isDebuggerActivated);\n\n        if (error) setError(null);\n        if (!loading) setLoading(true);\n\n        if (cache.current[url]) {\n            logDebugger(\"Get data from cache, no need a new request\", isDebuggerActivated);\n            if (typeof manipulate === \"function\") logDebugger(\"Manipulate data before saving\", isDebuggerActivated);\n\n            setData(cache.current[url]);\n            timeoutCacheClear(options, cache);\n            setLoading(false);\n            return;\n        }\n\n        try {\n            logDebugger(\"No data found in cache, proceed to do a new request...\", isDebuggerActivated);\n\n            const response = await fetch(url, { method, headers, data: body });\n            const result = await response.json();\n\n            if (response.ok) {\n                const _result = selector ? result[selector] : result;\n                if (typeof manipulate === \"function\") logDebugger(\"Manipulate data before saving\", isDebuggerActivated);\n                setData(typeof manipulate === \"function\" ? manipulate(_result) : _result);\n                logDebugger(\"Request done\", isDebuggerActivated);\n                cache.current[url] = typeof manipulate === \"function\" ? manipulate(_result) : _result;\n                timeoutCacheClear(options, cache);\n                logDebugger(`New data saved on cache for: \"${url}\"`, isDebuggerActivated);\n            } else {\n                setError(result);\n                logDebugger(\"An error occurred\", isDebuggerActivated, true, result);\n            }\n        } catch (err) {\n            setError(err);\n            logDebugger(\"An error occurred\", isDebuggerActivated, true, err);\n        } finally {\n            setLoading(false);\n            logDebugger(\"Data seatled, process done\", isDebuggerActivated);\n        }\n    };\n\n    useEffect (() => {\n        fetchData();\n    }, [url]);\n\n    return {\n        data,\n        error,\n        loading,\n        updateData: setData,\n        refresh: fetchData,\n        cache: {\n            get: (url) => {\n                return url ? cache.current[url] : cache.current;\n            },\n            has: (url) => {\n                return cache.current[url];\n            },\n            clear: () => {\n                cache.current = {};\n                logDebugger(`Cache cleared`, isDebuggerActivated);\n            }\n        }\n    };\n};"],"names":["DEFAULT_OPTIONS","selector","undefined","manipulate","method","headers","body","isDebuggerActivated","cacheTimeout","logDebugger","message","isError","error","console","Date","toLocaleTimeString","log","validateOptions","options","keys","Object","symDifference","filter","item","includes","Error","indexOf","toUpperCase","Array","isArray","length","join","timeoutCacheClear","cache","clearTimeout","setTimeout","current","QueryContext","createContext","useQueryContext","useContext","_ref","children","_useState","useState","h","Provider","value","url","_extends","_DEFAULT_OPTIONS$opti","useRef","_useQueryContext","data","setData","_useState2","setError","_useState3","loading","setLoading","fetchData","Promise","resolve","_temp","finalizer","result","e","then","bind","_finallyRethrows","_catch","recover","fetch","response","json","ok","_result","err","_wasThrown","_result2","reject","useEffect","updateData","refresh","get","has","clear"],"mappings":"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"}